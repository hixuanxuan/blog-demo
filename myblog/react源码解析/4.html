<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>创建更新的方式 | Xuanxuan&#39;s blog</title>
    <meta name="description" content="我的个人网站">
    <link rel="icon" href="./rabbit.png">
    
    <link rel="preload" href="/blog-demo/assets/css/0.styles.a4c10295.css" as="style"><link rel="preload" href="/blog-demo/assets/js/app.1d89a26a.js" as="script"><link rel="preload" href="/blog-demo/assets/js/2.e056be92.js" as="script"><link rel="preload" href="/blog-demo/assets/js/25.1d8f9bed.js" as="script"><link rel="prefetch" href="/blog-demo/assets/js/10.4bdca461.js"><link rel="prefetch" href="/blog-demo/assets/js/11.f3631a30.js"><link rel="prefetch" href="/blog-demo/assets/js/12.3baef48e.js"><link rel="prefetch" href="/blog-demo/assets/js/13.9da9935f.js"><link rel="prefetch" href="/blog-demo/assets/js/14.eeaa6772.js"><link rel="prefetch" href="/blog-demo/assets/js/15.8c2f0fd5.js"><link rel="prefetch" href="/blog-demo/assets/js/16.6f1b9cd3.js"><link rel="prefetch" href="/blog-demo/assets/js/17.a21e6f1b.js"><link rel="prefetch" href="/blog-demo/assets/js/18.9a0a4250.js"><link rel="prefetch" href="/blog-demo/assets/js/19.94c67f3b.js"><link rel="prefetch" href="/blog-demo/assets/js/20.aff2ca1c.js"><link rel="prefetch" href="/blog-demo/assets/js/21.e5295bc9.js"><link rel="prefetch" href="/blog-demo/assets/js/22.74b3cda7.js"><link rel="prefetch" href="/blog-demo/assets/js/23.9cb487fb.js"><link rel="prefetch" href="/blog-demo/assets/js/24.6e8dd019.js"><link rel="prefetch" href="/blog-demo/assets/js/26.40eae98a.js"><link rel="prefetch" href="/blog-demo/assets/js/27.b7aaa278.js"><link rel="prefetch" href="/blog-demo/assets/js/28.53c77287.js"><link rel="prefetch" href="/blog-demo/assets/js/29.1f3af06f.js"><link rel="prefetch" href="/blog-demo/assets/js/3.a70938db.js"><link rel="prefetch" href="/blog-demo/assets/js/30.5f5b1d34.js"><link rel="prefetch" href="/blog-demo/assets/js/31.3a9b3f3a.js"><link rel="prefetch" href="/blog-demo/assets/js/32.e00d4b9b.js"><link rel="prefetch" href="/blog-demo/assets/js/33.39317c8a.js"><link rel="prefetch" href="/blog-demo/assets/js/34.f1a0629c.js"><link rel="prefetch" href="/blog-demo/assets/js/35.b9538080.js"><link rel="prefetch" href="/blog-demo/assets/js/36.2d204a03.js"><link rel="prefetch" href="/blog-demo/assets/js/37.b72bb3d1.js"><link rel="prefetch" href="/blog-demo/assets/js/38.6a4765f0.js"><link rel="prefetch" href="/blog-demo/assets/js/39.76f36664.js"><link rel="prefetch" href="/blog-demo/assets/js/4.0f3eb812.js"><link rel="prefetch" href="/blog-demo/assets/js/40.cb590e60.js"><link rel="prefetch" href="/blog-demo/assets/js/41.6ce6059a.js"><link rel="prefetch" href="/blog-demo/assets/js/42.949c19e3.js"><link rel="prefetch" href="/blog-demo/assets/js/43.67e1bd45.js"><link rel="prefetch" href="/blog-demo/assets/js/44.c4e0b23d.js"><link rel="prefetch" href="/blog-demo/assets/js/45.4f7fee8b.js"><link rel="prefetch" href="/blog-demo/assets/js/46.0f5696db.js"><link rel="prefetch" href="/blog-demo/assets/js/47.b5d59a1d.js"><link rel="prefetch" href="/blog-demo/assets/js/48.f519ab65.js"><link rel="prefetch" href="/blog-demo/assets/js/5.d6f30415.js"><link rel="prefetch" href="/blog-demo/assets/js/6.5f6ad1ed.js"><link rel="prefetch" href="/blog-demo/assets/js/7.94c09ca7.js"><link rel="prefetch" href="/blog-demo/assets/js/8.16be45ff.js"><link rel="prefetch" href="/blog-demo/assets/js/9.6d10ac90.js">
    <link rel="stylesheet" href="/blog-demo/assets/css/0.styles.a4c10295.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog-demo/" class="home-link router-link-active"><!----> <span class="site-name">Xuanxuan's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog-demo/accumulate/" class="nav-link">前端基础</a></div><div class="nav-item"><a href="/blog-demo/algorithm/" class="nav-link">算法题库</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog-demo/accumulate/" class="nav-link">前端基础</a></div><div class="nav-item"><a href="/blog-demo/algorithm/" class="nav-link">算法题库</a></div><div class="nav-item"><a href="https://baidu.com" target="_blank" rel="noopener noreferrer" class="nav-link external">
  微博
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/blog-demo/" class="sidebar-link">简介</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>知识点整理</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>react源码简单阅读</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog-demo/myblog/react源码解析/1.html" class="sidebar-link">第一部分</a></li><li><a href="/blog-demo/myblog/react源码解析/2.html" class="sidebar-link">第二部分</a></li><li><a href="/blog-demo/myblog/react源码解析/3.html" class="sidebar-link">第三部分</a></li><li><a href="/blog-demo/myblog/react源码解析/4.html" class="active sidebar-link">第四部分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog-demo/myblog/react源码解析/4.html#创建更新的方式" class="sidebar-link">创建更新的方式</a></li><li class="sidebar-sub-header"><a href="/blog-demo/myblog/react源码解析/4.html#react-fiber" class="sidebar-link">react Fiber</a></li><li class="sidebar-sub-header"><a href="/blog-demo/myblog/react源码解析/4.html#fiberroot" class="sidebar-link">FiberRoot</a></li><li class="sidebar-sub-header"><a href="/blog-demo/myblog/react源码解析/4.html#fiber" class="sidebar-link">Fiber</a></li><li class="sidebar-sub-header"><a href="/blog-demo/myblog/react源码解析/4.html#不同的expiration-time" class="sidebar-link">不同的expiration Time</a></li></ul></li><li><a href="/blog-demo/myblog/react源码解析/hook.html" class="sidebar-link">hook</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>设计模式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>考点</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="创建更新的方式"><a href="#创建更新的方式" class="header-anchor">#</a> 创建更新的方式</h2> <ul><li>ReactDOM.render || hydrate</li> <li>setState</li> <li>forceUpdate</li></ul> <h3 id="步骤"><a href="#步骤" class="header-anchor">#</a> 步骤</h3> <ul><li>创建ReactRoot</li> <li>创建FiberRoot和RootFiber</li> <li>创建更新（进入调度后就是调度器负责）</li></ul> <h2 id="react-fiber"><a href="#react-fiber" class="header-anchor">#</a> react Fiber</h2> <p>React16后，迎来了react fiber。
Fiber 其实指的是一种数据结构，它可以用一个纯 JS 对象来表示：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> fiber <span class="token operator">=</span> <span class="token punctuation">{</span>
    stateNode<span class="token punctuation">,</span>    <span class="token comment">// 节点实例</span>
    child<span class="token punctuation">,</span>        <span class="token comment">// 子节点</span>
    sibling<span class="token punctuation">,</span>      <span class="token comment">// 兄弟节点</span>
    <span class="token keyword">return</span><span class="token punctuation">,</span>       <span class="token comment">// 父节点</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Fiber Reconciler 每执行一段时间，都会将控制权交回给浏览器，可以分段执行.</p> <h2 id="fiberroot"><a href="#fiberroot" class="header-anchor">#</a> FiberRoot</h2> <h3 id="_1-1-作用"><a href="#_1-1-作用" class="header-anchor">#</a> 1.1 作用</h3> <ul><li>整个应用的起点</li> <li>包含应用挂载的目标结点</li></ul> <div class="language- extra-class"><pre class="language-text"><code>&lt;div id='root'&gt;root&lt;/div
</code></pre></div><ul><li>记录整个应用更新过程的各种信息</li></ul> <h3 id="_1-2-与rootfiber的关系"><a href="#_1-2-与rootfiber的关系" class="header-anchor">#</a> 1.2 与RootFiber的关系</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>FiberRoot<span class="token punctuation">.</span>current <span class="token operator">=</span> RootFiber
RootFiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> FiberRoot
</code></pre></div><h3 id="_1-3-api"><a href="#_1-3-api" class="header-anchor">#</a> 1.3 api</h3> <p><code>createFiberRoot()</code></p> <p>作用：初始化fiberRoot和rootFiber</p> <h2 id="fiber"><a href="#fiber" class="header-anchor">#</a> Fiber</h2> <ul><li>每一个reactElement对应一个Fiber对象</li> <li>记录节点的各种状态（比如class component的state和props，记录在Fiber上面，在Fiber上操作，更新了之后才能放在state和props上面，这样也给日后的Hook形成了方便，虽然Hook没有this，但是我们的操作都在Fiber上面）</li> <li>串联整个应用（在ReactElement里面 通过 props.Children 把每个结点都串联起来，Fiber里面也有这个能力把结点串联起来）</li></ul> <p>React Fiber的工作分为下面两个阶段</p> <ol><li><p>render/reconcilition：寻找Element Tree的更新点，并转换成合并为单次Dom操作。</p></li> <li><p>commit： 这个阶段主要是把上个阶段生成的DOM操作去真正的执行。</p></li></ol> <p>对比新老算法：
老的算法的执行是：Render -&gt; 只要出发就不停的一大堆计算 -&gt; commit 提交
新的算法的执行是：Render -&gt; 一个个小的工作单元  ----&gt; 异步执行完成后 -&gt; commit提交 ---&gt; 异步分散在不同的帧中执行
fiber这种数据结构是原有React的元素数据结构的升级版，它包含了每个fiber对应的元素的信息、该元素的更新操作队列、类型等。
下面是Fiber</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Fiber对应一个组件需要被处理或者已经处理了，一个组件可以有一个或者多个Fiber</span>
type Fiber <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token operator">|</span>
  <span class="token comment">// 标记不同的组件类型</span>
  tag<span class="token operator">:</span> WorkTag<span class="token punctuation">,</span>

  <span class="token comment">// ReactElement里面的key</span>
  key<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> string<span class="token punctuation">,</span>

  <span class="token comment">// ReactElement.type，也就是我们调用`createElement`的第一个参数</span>
  elementType<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// The resolved function/class/ associated with this fiber.</span>
  <span class="token comment">// 异步组件resolved之后返回的内容，一般是`function`或者`class`</span>
  type<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// The local state associated with this fiber.</span>
  <span class="token comment">// 跟当前Fiber相关本地状态（比如浏览器环境就是DOM节点）</span>
  stateNode<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 指向他在Fiber节点树中的`parent`，用来在处理完这个节点之后向上返回</span>
  <span class="token keyword">return</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 单链表树结构</span>
  <span class="token comment">// 指向自己的第一个子节点</span>
  child<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 指向自己的兄弟结构</span>
  <span class="token comment">// 兄弟节点的return指向同一个父节点</span>
  sibling<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  index<span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// ref属性</span>
  ref<span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">handle<span class="token operator">:</span> mixed</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span>_stringRef<span class="token operator">:</span> <span class="token operator">?</span>string<span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">|</span> RefObject<span class="token punctuation">,</span>

  <span class="token comment">// 新的变动带来的新的props</span>
  pendingProps<span class="token operator">:</span> any<span class="token punctuation">,</span> 
  <span class="token comment">// 上一次渲染完成之后的props</span>
  memoizedProps<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 该Fiber对应的组件产生的Update会存放在这个队列里面</span>
  updateQueue<span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>any<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 上一次渲染的时候的state</span>
  memoizedState<span class="token operator">:</span> any<span class="token punctuation">,</span>

  <span class="token comment">// 一个列表，存放这个Fiber依赖的context</span>
  firstContextDependency<span class="token operator">:</span> ContextDependency<span class="token operator">&lt;</span>mixed<span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 用来描述当前Fiber和他子树的`Bitfield`</span>
  <span class="token comment">// 共存的模式表示这个子树是否默认是异步渲染的</span>
  <span class="token comment">// Fiber被创建的时候他会继承父Fiber</span>
  <span class="token comment">// 其他的标识也可以在创建的时候被设置</span>
  <span class="token comment">// 但是在创建之后不应该再被修改，特别是他的子Fiber创建之前</span>
  mode<span class="token operator">:</span> TypeOfMode<span class="token punctuation">,</span>

  <span class="token comment">// Effect</span>
  <span class="token comment">// 用来记录Side Effect</span>
  effectTag<span class="token operator">:</span> SideEffectTag<span class="token punctuation">,</span>

  <span class="token comment">// 单链表用来快速查找下一个side effect</span>
  nextEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 子树中第一个side effect</span>
  firstEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  <span class="token comment">// 子树中最后一个side effect</span>
  lastEffect<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 代表任务在未来的哪个时间点应该被完成</span>
  <span class="token comment">// 不包括他的子树产生的任务</span>
  expirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>

  <span class="token comment">// 快速确定子树中是否有不在等待的变化</span>
  childExpirationTime<span class="token operator">:</span> ExpirationTime<span class="token punctuation">,</span>

  <span class="token comment">// 在Fiber树更新的过程中，每个Fiber都会有一个跟其对应的Fiber</span>
  <span class="token comment">// 我们称他为`current &lt;==&gt; workInProgress`</span>
  <span class="token comment">// 在渲染完成之后他们会交换位置</span>
  alternate<span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>

  <span class="token comment">// 下面是调试相关的，收集每个Fiber和子树渲染时间的</span>

  actualDuration<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// If the Fiber is currently active in the &quot;render&quot; phase,</span>
  <span class="token comment">// This marks the time at which the work began.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  actualStartTime<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// Duration of the most recent render time for this Fiber.</span>
  <span class="token comment">// This value is not updated when we bailout for memoization purposes.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  selfBaseDuration<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// Sum of base times for all descedents of this Fiber.</span>
  <span class="token comment">// This value bubbles up during the &quot;complete&quot; phase.</span>
  <span class="token comment">// This field is only set when the enableProfilerTimer flag is enabled.</span>
  treeBaseDuration<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>

  <span class="token comment">// Conceptual aliases</span>
  <span class="token comment">// workInProgress : Fiber -&gt;  alternate The alternate used for reuse happens</span>
  <span class="token comment">// to be the same as work in progress.</span>
  <span class="token comment">// __DEV__ only</span>
  _debugID<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">,</span>
  _debugSource<span class="token operator">?</span><span class="token operator">:</span> Source <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  _debugOwner<span class="token operator">?</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  _debugIsCurrentlyTiming<span class="token operator">?</span><span class="token operator">:</span> boolean<span class="token punctuation">,</span>
<span class="token operator">|</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="不同的expiration-time"><a href="#不同的expiration-time" class="header-anchor">#</a> 不同的expiration Time</h2> <p>在React中，为防止某个update因为优先级的原因一直被打断而未能执行。React会设置一个ExpirationTime（在这个时间你都可以打断我），当时间到了ExpirationTime的时候，如果某个update还未执行的话，React将会强制执行该update（强制把这个任务执行）。</p> <h3 id="_1-1-种类"><a href="#_1-1-种类" class="header-anchor">#</a> 1.1 种类</h3> <ul><li>Sync模式（优先级最高，任务创建之后就要立即更新到dom）</li> <li>异步模式（优先级较低，可能被中断，但优先级不同）</li> <li>指定context</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog-demo/myblog/react源码解析/3.html" class="prev">第三部分</a></span> <span class="next"><a href="/blog-demo/myblog/react源码解析/hook.html">hook</a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog-demo/assets/js/app.1d89a26a.js" defer></script><script src="/blog-demo/assets/js/2.e056be92.js" defer></script><script src="/blog-demo/assets/js/25.1d8f9bed.js" defer></script>
  </body>
</html>
